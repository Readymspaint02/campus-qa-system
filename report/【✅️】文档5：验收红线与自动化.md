我将根据周震的任务书（基于微信小程序的校园服务智能问答系统）和已有的5文档体系，为其撰写专属的【文档5：验收红线与自动化】。

---

# 文档5：验收红线与自动化

**文档版本**：v1.0  
**编写日期**：2026年2月19日  
**编写人**：周震  
**指导教师**：邓娜/张陈晨  
**所属院系**：计算机系 24gbs计算一班  
**文档定位**：5文档作战体系最终层，上线前唯一质量门禁

---

## 一、设计原则：从20+项检查到3条红线

```
【原则1】自动化优先：能脚本化的不人工检查
【原则2】红线一票否决：未通过禁止上线，无例外
【原则3】开发即验收：每次提交自动触发基础检查
【原则4】问题可追溯：失败自动定位到具体文档条款
```

**与校园服务系统痛点的对应**：

| 校园服务痛点     | 本方案解决                | 验证方式          |
| :--------------- | :------------------------ | :---------------- |
| 信息分散查询不便 | 红线1：智能检索准确率100% | 自动化测试用例    |
| 通知推送丢失     | 红线2：消息到达率≥99.5%   | 微信模板消息日志  |
| 问答内容不准确   | 红线3：知识库准确率≥98%   | 人工抽样+用户反馈 |
| 权限混乱         | 权限矩阵自动化校验        | SQL检查           |
| 并发搜索卡顿     | 50并发压测                | JMeter自动化      |

---

## 二、三条红线（Red Lines）

### 🔴 红线1：智能检索核心指标 = 100%通过

**来源**：《任务书》智能问答核心模块 + 《开题报告》技术约束

**检查维度**：

| 指标             | 定义                  | 阈值   | 检查方法          |
| :--------------- | :-------------------- | :----- | :---------------- |
| 关键词匹配准确率 | 标准问题库Top3命中率  | ≥95%   | 自动化测试集500条 |
| 意图识别准确率   | 规则模板识别正确率    | ≥90%   | 人工标注100条测试 |
| 响应时间P99      | 端到端搜索延迟        | <500ms | JMeter压测        |
| 分词有效性       | Jieba分词后检索覆盖率 | ≥98%   | 对比测试          |

**检查脚本**（`check-search-accuracy.sh`）：

```bash
#!/bin/bash
# ============================================
# 红线1：智能检索准确率检查
# 来源：《任务书》智能问答核心模块 + 技术约束
# ============================================

echo "【红线1】智能检索核心指标检查..."

# 1. 准备测试数据集（500条标准问答对）
TEST_DATA="test/qa_benchmark_500.json"
if [ ! -f "$TEST_DATA" ]; then
    echo "❌ 测试数据集不存在: $TEST_DATA"
    exit 1
fi

# 2. 执行自动化检索测试
echo "执行检索准确率测试..."
curl -s -X POST http://localhost:8080/api/v1/qa/batch-test \
    -H "Content-Type: application/json" \
    -d @"$TEST_DATA" > /tmp/search_result.json

# 3. 解析结果
ACCURACY=$(jq '.accuracy' /tmp/search_result.json)
P99_LATENCY=$(jq '.p99Latency' /tmp/search_result.json)
COVERAGE=$(jq '.coverage' /tmp/search_result.json)

echo "关键词匹配准确率: ${ACCURACY}% (目标: ≥95%)"
echo "P99响应时间: ${P99_LATENCY}ms (目标: <500ms)"
echo "分词覆盖率: ${COVERAGE}% (目标: ≥98%)"

# 4. 判定
if (( $(echo "$ACCURACY >= 95" | bc -l) )) && \
   (( $(echo "$P99_LATENCY < 500" | bc -l) )) && \
   (( $(echo "$COVERAGE >= 98" | bc -l) )); then
    echo "✅ 红线1通过"
    exit 0
else
    echo "❌ 红线1未通过"
    exit 1
fi
```

**测试数据集格式**（`qa_benchmark_500.json`）：

```json
{
  "testCases": [
    {
      "query": "图书馆几点开门",
      "expectedTop3": ["LIB-001", "LIB-002", "LIB-003"],
      "intent": "QUERY_TIME",
      "category": "后勤"
    },
    {
      "query": "怎么申请奖学金",
      "expectedTop3": ["XW-015", "XW-016"],
      "intent": "QUERY_PROCESS",
      "category": "学工"
    }
  ]
}
```

---

### 🔴 红线2：通知推送到达率 ≥ 99.5%

**来源**：《任务书》校园信息聚合与订阅模块 + 微信小程序订阅消息

**检查维度**：

| 指标           | 定义                 | 阈值   | 检查方法     |
| :------------- | :------------------- | :----- | :----------- |
| 模板消息到达率 | 成功推送/总推送      | ≥99.5% | 微信后台统计 |
| 订阅转化率     | 订阅用户数/活跃用户  | ≥30%   | 数据库统计   |
| 推送延迟P99    | 从发布到接收延迟     | <5分钟 | 日志分析     |
| 失败重试成功率 | 失败消息重试成功比例 | ≥95%   | 消息队列监控 |

**检查脚本**（`check-notification-reach.sh`）：

```bash
#!/bin/bash
# ============================================
# 红线2：通知推送到达率检查
# 来源：《任务书》通知订阅模块 + 微信模板消息
# ============================================

echo "【红线2】通知推送到达率检查..."

# 1. 查询最近24小时推送统计
mysql -u root -p campus_qa -N -e "
SELECT 
    COUNT(*) as total,
    SUM(CASE WHEN status = 'SUCCESS' THEN 1 ELSE 0 END) as success,
    SUM(CASE WHEN status = 'FAILED' THEN 1 ELSE 0 END) as failed,
    AVG(TIMESTAMPDIFF(SECOND, create_time, push_time)) as avg_delay_sec
FROM t_notification_log 
WHERE create_time > DATE_SUB(NOW(), INTERVAL 24 HOUR);
" > /tmp/push_stats.txt

# 2. 解析统计
TOTAL=$(awk '{print $1}' /tmp/push_stats.txt)
SUCCESS=$(awk '{print $2}' /tmp/push_stats.txt)
FAILED=$(awk '{print $3}' /tmp/push_stats.txt)
AVG_DELAY=$(awk '{print $4}' /tmp/push_stats.txt)

if [ "$TOTAL" -eq 0 ]; then
    echo "⚠️  24小时内无推送记录，跳过统计"
    exit 0
fi

# 3. 计算到达率
REACH_RATE=$(echo "scale=4; $SUCCESS / $TOTAL * 100" | bc)
echo "推送总数: $TOTAL"
echo "成功推送: $SUCCESS"
echo "到达率: ${REACH_RATE}% (目标: ≥99.5%)"
echo "平均延迟: ${AVG_DELAY}秒 (目标: <300秒)"

# 4. 检查失败重试
RETRY_SUCCESS=$(mysql -u root -p campus_qa -N -e "
SELECT COUNT(*) FROM t_notification_log 
WHERE status = 'SUCCESS' AND retry_count > 0 
  AND create_time > DATE_SUB(NOW(), INTERVAL 24 HOUR);
")
RETRY_TOTAL=$(mysql -u root -p campus_qa -N -e "
SELECT COUNT(*) FROM t_notification_log 
WHERE retry_count > 0 
  AND create_time > DATE_SUB(NOW(), INTERVAL 24 HOUR);
")

if [ "$RETRY_TOTAL" -gt 0 ]; then
    RETRY_RATE=$(echo "scale=4; $RETRY_SUCCESS / $RETRY_TOTAL * 100" | bc)
    echo "重试成功率: ${RETRY_RATE}% (目标: ≥95%)"
fi

# 5. 判定
if (( $(echo "$REACH_RATE >= 99.5" | bc -l) )); then
    echo "✅ 红线2通过"
    exit 0
else
    echo "❌ 红线2未通过：到达率不足99.5%"
    exit 1
fi
```

**数据库表设计**（`t_notification_log`）：

```sql
CREATE TABLE `t_notification_log` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    `template_id` VARCHAR(64) NOT NULL COMMENT '微信模板ID',
    `content` JSON COMMENT '推送内容',
    `status` TINYINT NOT NULL DEFAULT 0 COMMENT '0-待发送 1-成功 2-失败 3-重试中',
    `retry_count` TINYINT DEFAULT 0 COMMENT '重试次数',
    `fail_reason` VARCHAR(255) DEFAULT NULL COMMENT '失败原因',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `push_time` DATETIME DEFAULT NULL COMMENT '实际推送时间',
    PRIMARY KEY (`id`),
    KEY `idx_user_time` (`user_id`, `create_time`),
    KEY `idx_status` (`status`)
) ENGINE=InnoDB COMMENT='通知推送日志';
```

---

### 🔴 红线3：50并发压测成功率 ≥ 99.9%

**来源**：《任务书》技术约束 + 《开题报告》进度安排

**检查维度**：

| 指标           | 定义         | 阈值   | 检查方法   |
| :------------- | :----------- | :----- | :--------- |
| 搜索接口成功率 | HTTP 200比例 | ≥99.9% | JMeter压测 |
| P99响应时间    | 搜索接口延迟 | <500ms | JMeter报告 |
| 并发用户数     | 同时在线搜索 | 50用户 | 线程组配置 |
| 错误率         | 5xx错误比例  | <0.1%  | 响应断言   |

**JMeter测试计划**（`campus-qa-50concurrent.jmx`）：

```xml
<?xml version="1.0" encoding="UTF-8"?>
<TestPlan guiclass="TestPlanGui" testname="校园问答系统50并发压测">
  <ThreadGroup guiclass="ThreadGroupGui" testname="50并发用户">
    <stringProp name="ThreadGroup.num_threads">50</stringProp>
    <stringProp name="ThreadGroup.ramp_time">10</stringProp>
    <stringProp name="ThreadGroup.duration">600</stringProp>
    
    <!-- 搜索接口压测 -->
    <HTTPSamplerProxy guiclass="HttpTestSampleGui" testname="智能搜索">
      <stringProp name="HTTPSampler.domain">localhost</stringProp>
      <stringProp name="HTTPSampler.port">8080</stringProp>
      <stringProp name="HTTPSampler.path">/api/v1/qa/search</stringProp>
      <stringProp name="HTTPSampler.method">POST</stringProp>
      <stringProp name="HTTPSampler.postBody">
        {"query": "${__RandomString(5,abcdefghijklmnopqrstuvwxyz,)}", "categoryId": ${__Random(1,5,)}}
      </stringProp>
    </HTTPSamplerProxy>
    
    <!-- 断言：成功率 -->
    <ResponseAssertion guiclass="AssertionGui" testname="成功率断言">
      <collectionProp name="Asserion.test_strings">
        <stringProp name="49586">A0000</stringProp>
      </collectionProp>
      <stringProp name="Assertion.test_field">Assertion.response_code</stringProp>
    </ResponseAssertion>
    
    <!-- 断言：响应时间 -->
    <DurationAssertion guiclass="DurationAssertionGui" testname="响应时间断言">
      <stringProp name="DurationAssertion.duration">500</stringProp>
    </DurationAssertion>
  </ThreadGroup>
</TestPlan>
```

**执行脚本**（`run-concurrent-test.sh`）：

```bash
#!/bin/bash
# ============================================
# 红线3：50并发压测
# 来源：《任务书》技术约束 + 性能要求
# ============================================

JMETER_HOME="/opt/jmeter"
TEST_PLAN="campus-qa-50concurrent.jmx"
RESULT_FILE="result-$(date +%Y%m%d-%H%M%S).jtl"
REPORT_DIR="report-$(date +%Y%m%d-%H%M%S)"

echo "【红线3】50并发压测执行..."

# 前置检查
redis-cli ping | grep -q "PONG" || { echo "❌ Redis未启动"; exit 1; }
mysql -u root -p -e "SELECT 1" campus_qa > /dev/null 2>&1 || { echo "❌ MySQL未启动"; exit 1; }

# 执行压测
$JMETER_HOME/bin/jmeter -n \
    -t $TEST_PLAN \
    -l $RESULT_FILE \
    -e -o $REPORT_DIR

# 解析结果
SUCCESS_RATE=$(awk -F',' 'NR>1 && $7=="true" {count++} END {print count/(NR-1)*100}' $RESULT_FILE)
P99_LATENCY=$(awk -F',' 'NR>1 {print $14}' $RESULT_FILE | sort -n | awk 'NR==int(NR*0.99)')

echo "成功率: ${SUCCESS_RATE}% (目标: ≥99.9%)"
echo "P99延迟: ${P99_LATENCY}ms (目标: <500ms)"

# 判定
if (( $(echo "$SUCCESS_RATE >= 99.9" | bc -l) )) && \
   (( $(echo "$P99_LATENCY < 500" | bc -l) )); then
    echo "✅ 红线3通过"
    exit 0
else
    echo "❌ 红线3未通过"
    exit 1
fi
```

---

## 三、日终对账与一致性校验SQL

**来源**：《任务书》数据统计与分析模块 + 资金安全要求

```sql
-- ============================================
-- 校园问答系统日终对账SQL
-- 执行时间：每日凌晨2:00
-- ============================================

-- 检查1：用户搜索历史完整性（防止记录丢失）
SELECT 
    '【致命】搜索历史丢失' as check_item,
    COUNT(*) as lost_count
FROM t_search_history h
LEFT JOIN t_user u ON h.user_id = u.id
WHERE h.create_time > DATE_SUB(NOW(), INTERVAL 1 DAY)
  AND u.id IS NULL;

-- 检查2：问答点击量一致性（防止刷量）
SELECT 
    '【警告】点击量异常' as check_item,
    qa.id,
    qa.click_count as db_count,
    COUNT(l.id) as log_count
FROM t_qa_pair qa
LEFT JOIN t_click_log l ON l.qa_id = qa.id 
    AND l.create_time > DATE_SUB(NOW(), INTERVAL 1 DAY)
WHERE qa.click_count > 0
GROUP BY qa.id
HAVING ABS(qa.click_count - COUNT(l.id)) > 10;

-- 检查3：订阅关系有效性（防止僵尸订阅）
SELECT 
    '【致命】僵尸订阅' as check_item,
    s.id,
    s.user_id,
    s.department_id
FROM t_subscription s
LEFT JOIN t_user u ON s.user_id = u.id
WHERE s.status = 1 
  AND (u.id IS NULL OR u.status != 1);

-- 检查4：通知推送状态一致性
SELECT 
    '【警告】推送状态不一致' as check_item,
    n.id,
    n.status,
    w.status as wx_status
FROM t_notification_log n
LEFT JOIN t_wx_push_record w ON n.id = w.log_id
WHERE n.create_time > DATE_SUB(NOW(), INTERVAL 1 DAY)
  AND n.status = 1  -- 标记成功
  AND (w.status IS NULL OR w.status != 'SUCCESS');

-- 检查5：收藏数据完整性
SELECT 
    '【致命】收藏记录孤儿' as check_item,
    f.id,
    f.user_id,
    f.qa_id
FROM t_favorite f
LEFT JOIN t_qa_pair qa ON f.qa_id = qa.id
WHERE qa.id IS NULL OR qa.status = 0;  -- 已删除或下架
```

---

## 四、一键验收命令

### 4.1 全量检查脚本（`check-all.sh`）

```bash
#!/bin/bash
# ============================================
# 校园问答系统 - 一键全量验收
# 编写人：周震
# 指导教师：邓娜/张陈晨
# ============================================

set -e

echo "=========================================="
echo "校园服务智能问答系统 - 上线前验收"
echo "执行时间: $(date '+%Y-%m-%d %H:%M:%S')"
echo "=========================================="

# 检查0：环境就绪
echo -e "\n【检查0】环境就绪性..."
redis-cli ping | grep -q "PONG" || { echo "❌ Redis未启动"; exit 1; }
mysql -u root -p -e "SELECT 1" campus_qa > /dev/null 2>&1 || { echo "❌ MySQL未启动"; exit 1; }
echo "✅ 环境就绪"

# 红线1：智能检索准确率
echo -e "\n【红线1】智能检索核心指标..."
bash check-search-accuracy.sh || exit 1

# 红线2：通知推送到达率
echo -e "\n【红线2】通知推送到达率..."
bash check-notification-reach.sh || exit 1

# 红线3：并发压测
echo -e "\n【红线3】50并发压测..."
bash run-concurrent-test.sh || exit 1

# 附加检查：日终对账
echo -e "\n【附加】日终对账SQL..."
mysql -u root -p campus_qa < check-daily.sql > /tmp/daily-check.log 2>&1
if grep -q "【致命】" /tmp/daily-check.log; then
    echo "❌ 日终对账发现致命问题："
    grep "【致命】" /tmp/daily-check.log
    exit 1
else
    echo "✅ 日终对账通过"
fi

# 最终报告
echo -e "\n=========================================="
echo "✅ 全部红线通过，允许上线"
echo "验收时间: $(date '+%Y-%m-%d %H:%M:%S')"
echo "=========================================="

# 生成验收报告
cat > acceptance-report-$(date +%Y%m%d).md << EOF
# 校园服务智能问答系统 - 上线验收报告

| 检查项 | 结果 | 时间 |
|:---|:---|:---|
| 红线1：智能检索准确率 | 通过 | $(date '+%H:%M:%S') |
| 红线2：通知推送到达率 | 通过 | $(date '+%H:%M:%S') |
| 红线3：50并发压测 | 通过 | $(date '+%H:%M:%S') |
| 日终对账 | 通过 | $(date '+%H:%M:%S') |

**系统信息**：
- 系统名称：基于微信小程序的校园服务智能问答系统
- 技术栈：微信小程序原生 + Vue 3 + SpringBoot 2.7.x + MySQL 8.0
- 开发人：周震
- 指导教师：邓娜/张陈晨

**签字确认**：
- 开发人：___________
- 指导教师：___________  
- 日期：$(date '+%Y-%m-%d')
EOF

echo "验收报告已生成: acceptance-report-$(date +%Y%m%d).md"
```

### 4.2 提交前快速检查（`check-commit.sh`）

```bash
#!/bin/bash
# ============================================
# 提交前快速检查
# ============================================

echo "【提交前检查】..."

# 检查1：XML无未转义字符（全文检索SQL）
if rg "MATCH.*AGAINST" --type xml src/ | rg -v "CDATA" > /dev/null 2>&1; then
    echo "⚠️  发现全文检索SQL未使用CDATA包裹"
fi

# 检查2：微信敏感信息未硬编码
if rg "appid|secret" --type java src/ | rg -v "application.yml" > /dev/null 2>&1; then
    echo "❌ 发现微信敏感信息可能硬编码在代码中"
    exit 1
fi

# 检查3：Jieba分词配置检查
if [ ! -f "src/main/resources/jieba.dict" ]; then
    echo "⚠️  Jieba自定义词典不存在"
fi

# 检查4：小程序代码规范
if [ -d "miniprogram" ]; then
    # 检查app.json配置
    if ! jq . miniprogram/app.json > /dev/null 2>&1; then
        echo "❌ app.json格式错误"
        exit 1
    fi
fi

echo "✅ 提交前检查通过"
```

---

## 五、与任务书功能模块对照

| 任务书模块             | 对应红线 | 验收方式   | 关键指标              |
| :--------------------- | :------- | :--------- | :-------------------- |
| **1.1 智能问答核心**   | 红线1    | 自动化测试 | 准确率≥95%，P99<500ms |
| **1.2 信息聚合与订阅** | 红线2    | 日志统计   | 到达率≥99.5%          |
| **1.3 个性化服务**     | 日终对账 | SQL检查    | 收藏/历史记录完整性   |
| **1.4 轻量事务指引**   | 日终对账 | SQL检查    | 办事指南数据一致性    |
| **2.1 问答知识库管理** | 红线1    | 人工+自动  | 内容准确率≥98%        |
| **2.2 动态通知管理**   | 红线2    | 日志统计   | 推送成功率≥99.5%      |
| **2.3 用户反馈处理**   | 日终对账 | SQL检查    | 反馈闭环率100%        |
| **3.1 多角色权限**     | 附加检查 | 渗透测试   | 越权操作0容忍         |
| **3.2 系统配置**       | 附加检查 | 配置审计   | 敏感信息无硬编码      |
| **3.3 数据统计**       | 日终对账 | SQL检查    | 统计数据准确性        |
| **3.4 内容安全**       | 附加检查 | 敏感词扫描 | 违规内容0容忍         |
| **3.5 系统监控**       | 红线3    | 压测+监控  | 50并发成功率≥99.9%    |

---

## 六、文档索引

| 本章节   | 来源文档     | 具体条款                |
| :------- | :----------- | :---------------------- |
| 红线1    | 《任务书》   | 技术约束-智能检索       |
| 红线1    | 《开题报告》 | 研究内容-多模式智能问答 |
| 红线2    | 《任务书》   | 1.2 校园信息聚合与订阅  |
| 红线2    | 《任务书》   | 技术约束-微信小程序     |
| 红线3    | 《任务书》   | 技术约束-性能要求       |
| 红线3    | 《开题报告》 | 进度安排-测试阶段       |
| 日终对账 | 《任务书》   | 3.3 数据统计与分析      |
| 一键命令 | 5文档体系    | 文档5通用模板           |

---

**文档结束**

> **执行口诀**：`./check-all.sh` 三行命令，决定上线生死。  
> **维护原则**：红线标准不变，脚本随校园业务迭代。  
> **与通用系统的区别**：针对微信小程序生态和校园场景定制，聚焦信息检索准确性和通知到达率。
 我来为你撰写周震同学的《基于微信小程序的校园服务智能问答系统》的**文档2：数据模型与状态机.md**。这个系统与艺术品交易平台有显著差异——它是**AI驱动的问答系统**，核心在于**知识库管理、对话流状态、模型调用链路**，而非电商交易的资金流和库存。

我将基于5文档体系的标准格式，结合智能问答系统的特点，重点设计：
- **知识库向量存储**（区别于关系型数据）
- **对话会话状态机**（多轮对话管理）
- **模型调用链路**（RAG检索+LLM生成）
- **反馈学习闭环**（用户点赞/点踩优化回答）

让我开始撰写这份文档。 
 基于搜索获取的RAG智能问答系统技术资料，我现在为你撰写周震同学的**《基于微信小程序的校园服务智能问答系统》文档2：数据模型与状态机.md**。这份文档将严格遵循5文档体系规范，同时针对AI问答系统的特殊性进行设计。

---

# 文档2：数据模型与状态机

**文档版本**：v1.0  
**编写日期**：2026-02-20  
**编写人**：周震  
**审核人**：刘建舟、宋桥白  
**适用范围**：基于微信小程序的校园服务智能问答系统全系统数据架构与状态管理

---

## 一、核心数据架构与领域模型

### 1.1 五大核心领域关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      校园智能问答系统领域模型                                  │
└─────────────────────────────────────────────────────────────────────────────┘

【用户域 User Domain】
t_user (1) ───< (N) t_user_tag ───> (N) t_tag
    │
    ├──< (N) t_conversation ──会话历史
    ├──< (N) t_feedback ──用户反馈（点赞/点踩）
    └──< (N) t_query_log ──查询日志（用于分析优化）

【知识域 Knowledge Domain】
t_knowledge_base (1) ───< (N) t_knowledge_chunk ──知识分片
    │
    ├──< (N) t_knowledge_category ──分类体系
    ├──< (1) t_vector_embedding ──向量表示（Milvus/ES）
    └──< (N) t_knowledge_relation ──知识关联（图谱）

【对话域 Conversation Domain】
t_conversation (1) ───< (N) t_message ──消息记录
    │
    ├──< (N) t_context_memory ──上下文记忆（滑动窗口）
    ├──< (N) t_intent_record ──意图识别记录
    └──< (N) t_slot_filling ──槽位填充状态

【模型域 Model Domain】
t_model_config (1) ───< (N) t_model_call_log ──模型调用日志
    │
    ├──< (N) t_retrieval_record ──检索记录（RAG链路）
    ├──< (N) t_rerank_record ──重排记录
    └──< (N) t_llm_response ──LLM生成记录

【运营域 Operation Domain】
t_admin (1) ───< (N) t_audit_log ──审核日志
    │
    ├──< (N) t_sensitive_word ──敏感词库
    ├──< (N) t_hot_question ──热点问题
    └──< (N) t_system_config ──系统配置
```

### 1.2 关键实体属性速查

| 实体                   | 核心字段                                              | 业务标识       | 关联关系                    |
| :--------------------- | :---------------------------------------------------- | :------------- | :-------------------------- |
| **t_user**             | id, openid, unionid, nickname, avatar, user_type      | 微信openid唯一 | 1:N conversation, feedback  |
| **t_conversation**     | id, user_id, session_id, status, start_time, end_time | session_id唯一 | 1:N message, context_memory |
| **t_message**          | id, conversation_id, role, content, msg_type, intent  | 消息序列号     | N:1 conversation            |
| **t_knowledge_base**   | id, kb_code, name, description, vector_store_type     | kb_code唯一    | 1:N knowledge_chunk         |
| **t_knowledge_chunk**  | id, kb_id, chunk_content, chunk_vector, metadata      | 向量ID         | N:1 knowledge_base          |
| **t_vector_embedding** | id, chunk_id, vector_data, dimension, model_version   | 向量唯一       | 1:1 knowledge_chunk         |
| **t_model_config**     | id, model_name, model_type, api_endpoint, priority    | model_name唯一 | 1:N model_call_log          |
| **t_feedback**         | id, user_id, message_id, feedback_type, content       | 联合唯一       | N:1 message                 |

### 1.3 数据库表清单（18张核心表）

| 序号 | 表名                   | 领域 | 存储类型       | 数据量预估 | 分表策略          |
| :--: | :--------------------- | :--- | :------------- | :--------- | :---------------- |
|  1   | t_user                 | 用户 | MySQL          | 10万       | 单表              |
|  2   | t_user_tag             | 用户 | MySQL          | 50万       | 单表              |
|  3   | t_tag                  | 用户 | MySQL          | 100条      | 单表              |
|  4   | **t_conversation**     | 对话 | MySQL          | 500万      | 按月分表          |
|  5   | **t_message**          | 对话 | MySQL          | 5000万     | 按月分表          |
|  6   | t_context_memory       | 对话 | Redis + MySQL  | 100万      | 滑动窗口，TTL 7天 |
|  7   | t_intent_record        | 对话 | MySQL          | 1000万     | 按月分表          |
|  8   | t_slot_filling         | 对话 | MySQL          | 500万      | 按月分表          |
|  9   | **t_knowledge_base**   | 知识 | MySQL          | 50条       | 单表              |
|  10  | **t_knowledge_chunk**  | 知识 | MySQL + 向量库 | 1000万     | 按kb_id分片       |
|  11  | **t_vector_embedding** | 知识 | Milvus/ES      | 1000万     | 向量索引分片      |
|  12  | t_knowledge_category   | 知识 | MySQL          | 500条      | 单表              |
|  13  | t_knowledge_relation   | 知识 | Neo4j/MongoDB  | 100万      | 图数据库          |
|  14  | **t_model_config**     | 模型 | MySQL          | 20条       | 单表              |
|  15  | **t_model_call_log**   | 模型 | MySQL          | 1亿+       | 按天分表          |
|  16  | t_retrieval_record     | 模型 | MySQL          | 5000万     | 按天分表          |
|  17  | t_feedback             | 运营 | MySQL          | 1000万     | 按月分表          |
|  18  | t_sensitive_word       | 运营 | MySQL + Redis  | 1万条      | 全量缓存          |

---

## 二、六大核心业务状态机

### 2.1 对话会话状态机（核心交互流程）

**状态定义**（5状态闭环）：

| 状态码            | 状态名     | 业务含义               | 允许操作            | 持续时间          |
| :---------------- | :--------- | :--------------------- | :------------------ | :---------------- |
| **INIT**          | 初始化     | 会话创建，等待首条消息 | 发送消息            | <5秒              |
| **UNDERSTANDING** | 意图识别中 | NLP处理用户输入        | 等待/取消           | <2秒              |
| **RETRIEVING**    | 知识检索中 | RAG向量检索+重排       | 等待                | <3秒              |
| **GENERATING**    | 答案生成中 | LLM流式生成回答        | 等待/中断           | <10秒             |
| **COMPLETED**     | 已完成     | 答案已送达，等待反馈   | 追问/点赞/点踩/结束 | 5分钟无交互则关闭 |
| **CLOSED**        | 已关闭     | 会话结束，归档存储     | 新建会话            | 永久              |

**状态流转图**：

```
INIT ──[用户发送消息]──► UNDERSTANDING ──[意图识别完成]──► RETRIEVING
  │                          │                              │
  │[超时/异常]                │[敏感词拦截]                  │[检索为空]
  ▼                          ▼                              ▼
CLOSED ◄───────────────── SENSITIVE_BLOCKED               FALLBACK_TO_LLM
  ▲                              │                              │
  │                              ▼                              │
  │                      [人工审核中]                           │
  │                                                              │
  │[用户追问]          [RAG检索完成]                             │
  └──────────────────── RETRIEVING ──[组装Prompt]──► GENERATING
                                                          │
                                                          │[流式输出完成]
                                                          ▼
                                                    COMPLETED ──[5分钟无交互]──► CLOSED
                                                          │
                                                          │[用户点赞/点踩]
                                                          ▼
                                                    FEEDBACK_RECORDED ──► CLOSED
```

**关键状态流转规则**：

```java
// 状态流转服务模板（对话专用）
@Service
@Slf4j
public class ConversationStatusService {
    
    @Autowired
    private ConversationMapper conversationMapper;
    
    @Autowired
    private MessageMapper messageMapper;
    
    /**
     * 对话状态流转（带上下文校验）
     */
    @Transactional
    public void transition(Long conversationId, ConvStatus from, ConvStatus to, 
                          String operator, Map<String, Object> context) {
        // 1. 乐观锁校验当前状态
        int affected = conversationMapper.updateStatus(conversationId, from, to, context);
        if (affected == 0) {
            Conv actual = conversationMapper.selectById(conversationId);
            throw new BizException(String.format(
                "会话状态流转失败：当前状态为%s，期望%s", actual.getStatus(), from
            ));
        }
        
        // 2. 触发对应业务动作
        switch (to) {
            case UNDERSTANDING:
                // 启动意图识别异步任务
                nlpService.asyncAnalyzeIntent(conversationId, context);
                break;
            case RETRIEVING:
                // 触发RAG检索流程
                ragService.asyncRetrieve(conversationId, context);
                break;
            case GENERATING:
                // 启动LLM流式生成
                llmService.asyncGenerate(conversationId, context);
                break;
            case COMPLETED:
                // 清理临时上下文，保留关键记忆
                contextMemoryService.archive(conversationId);
                break;
            case CLOSED:
                // 全量归档，释放Redis资源
                archiveService.fullArchive(conversationId);
                break;
        }
        
        // 3. 记录状态日志
        recordStatusHistory(conversationId, from, to, operator, context);
    }
}
```

### 2.2 消息处理状态机（单条消息生命周期）

**状态定义**（7状态）：

| 状态码               | 状态名       | 业务含义           | 触发条件     |
| :------------------- | :----------- | :----------------- | :----------- |
| **PENDING**          | 待处理       | 消息已接收，排队中 | 用户发送     |
| **FILTERING**        | 敏感词过滤中 | 进行内容安全校验   | 自动触发     |
| **BLOCKED**          | 已拦截       | 触发敏感词或违规   | 敏感词命中   |
| **INTENT_ANALYZING** | 意图分析中   | NLP解析用户意图    | 过滤通过     |
| **RETRIEVING**       | 知识检索中   | RAG检索相关知识    | 意图识别完成 |
| **GENERATING**       | 生成中       | LLM生成回答        | 检索完成     |
| **DELIVERED**        | 已送达       | 用户已收到回答     | 生成完成     |
| **FAILED**           | 失败         | 处理异常           | 任何环节出错 |

**与对话状态的区别**：对话状态管理**会话级**流程，消息状态管理**单条消息**的完整处理链路。

### 2.3 RAG检索状态机（知识增强链路）

**状态定义**（5状态）：

| 状态码                  | 状态名     | 业务含义               | 数据一致性要求                 |
| :---------------------- | :--------- | :--------------------- | :----------------------------- |
| **QUERY_VECTORIZED**    | 查询向量化 | 用户问题转为向量       | 必须成功，否则降级为关键词检索 |
| **VECTOR_SEARCHING**    | 向量检索中 | 在Milvus/ES中检索Top-K | 允许部分失败，自动重试         |
| **RERANKING**           | 重排中     | 使用Reranker模型精排   | 可选，失败则使用原始排序       |
| **CONTEXT_ASSEMBLING**  | 上下文组装 | 拼接Prompt模板         | 必须成功                       |
| **RETRIEVAL_COMPLETED** | 检索完成   | 知识片段准备就绪       | 记录检索质量指标               |

**检索质量校验公式**：

```sql
-- RAG检索质量日终校验（核心中的核心）
-- 来源：防止"检索为空但LLM hallucination"问题

-- 检查1：检索为空但LLM生成了回答（幻觉风险）
SELECT 
    '【致命】检索为空但有回答' as alert_level,
    m.id as message_id,
    m.conversation_id,
    r.retrieval_status,
    r.top_k_similarity,
    m.content as generated_answer,
    m.create_time
FROM t_message m
LEFT JOIN t_retrieval_record r ON m.id = r.message_id
WHERE m.role = 'ASSISTANT'
    AND m.msg_type = 'KNOWLEDGE'
    AND (r.id IS NULL OR r.top_k_similarity < 0.3)  -- 无检索或相似度极低
    AND LENGTH(m.content) > 50  -- 但生成了较长回答
    AND m.create_time > DATE_SUB(NOW(), INTERVAL 1 DAY);

-- 检查2：向量检索与关键词检索结果差异过大
SELECT 
    '【警告】检索结果不一致' as alert_level,
    r1.message_id,
    r1.vector_results,
    r2.keyword_results,
    r1.create_time
FROM t_retrieval_record r1
JOIN t_retrieval_record r2 ON r1.message_id = r2.message_id 
    AND r1.retrieval_type = 'VECTOR' 
    AND r2.retrieval_type = 'KEYWORD'
WHERE r1.top_k_ids != r2.top_k_ids  -- 结果集合差异
    AND r1.create_time > DATE_SUB(NOW(), INTERVAL 1 DAY);
```

### 2.4 LLM调用状态机（模型生成链路）

**状态定义**（6状态）：

| 状态码              | 状态名       | 业务含义                 | 降级策略                  |
| :------------------ | :----------- | :----------------------- | :------------------------ |
| **QUEUED**          | 排队中       | 等待模型资源             | 超时转本地模型            |
| **PROMPT_BUILDING** | Prompt构建中 | 组装系统提示+上下文+知识 | 失败返回模板错误          |
| **MODEL_CALLING**   | 模型调用中   | 向LLM API发送请求        | 超时重试/切换备用模型     |
| **STREAMING**       | 流式输出中   | 逐字返回生成内容         | 中断后返回已生成部分      |
| **COMPLETED**       | 完成         | 完整回答生成             | 记录Token消耗             |
| **FAILED**          | 失败         | 调用异常                 | 切换备用模型/返回兜底话术 |

**模型调用降级策略（四级）**：

| 级别   | 触发条件         | 策略                          | 代码开关                       |
| :----- | :--------------- | :---------------------------- | :----------------------------- |
| **L1** | 主模型响应>3秒   | 启用流式输出，先返回"思考中"  | `stream.enabled=true`          |
| **L2** | 主模型失败       | 切换备用模型（DeepSeek/Qwen） | `model.fallback.enabled=true`  |
| **L3** | 所有云端模型失败 | 启用本地轻量化模型（Qwen-7B） | `local.model.enabled=true`     |
| **L4** | 完全不可用       | 返回兜底话术+转人工入口       | `manual.transfer.enabled=true` |

### 2.5 知识库更新状态机（内容管理）

**状态定义**（6状态闭环）：

| 状态码          | 状态名     | 业务含义          | 允许操作       |
| :-------------- | :--------- | :---------------- | :------------- |
| **DRAFT**       | 草稿       | 知识录入，待处理  | 编辑/删除      |
| **PARSING**     | 解析中     | 文档解析/分片     | 等待           |
| **VECTORIZING** | 向量化中   | Embedding模型处理 | 等待           |
| **INDEXING**    | 索引构建中 | 写入向量数据库    | 等待           |
| **PUBLISHED**   | 已发布     | 知识可用          | 查询/更新/下线 |
| **OFFLINE**     | 已下线     | 知识不可用        | 重新发布/删除  |

**知识版本控制**：

```sql
-- 知识版本表（解决"知识更新但向量未更新"问题）
CREATE TABLE `t_knowledge_version` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    `kb_id` BIGINT UNSIGNED NOT NULL COMMENT '知识库ID',
    `version_no` VARCHAR(32) NOT NULL COMMENT '版本号 v1.0.0',
    `chunk_count` INT NOT NULL COMMENT '分片数量',
    `vector_count` INT NOT NULL COMMENT '向量数量',
    `build_time` DATETIME NOT NULL COMMENT '构建时间',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '1-生效中 2-已归档',
    `checksum` VARCHAR(64) NOT NULL COMMENT '内容校验和',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_kb_version` (`kb_id`, `version_no`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='知识版本表';
```

### 2.6 用户反馈状态机（闭环优化）

**状态定义**（4状态）：

| 状态码       | 状态名 | 业务含义           | 数据用途              |
| :----------- | :----- | :----------------- | :-------------------- |
| **PENDING**  | 待评价 | 回答已送达，未反馈 | 24小时后自动标记      |
| **LIKED**    | 已点赞 | 用户认可回答       | 正样本，强化相似检索  |
| **DISLIKED** | 已点踩 | 用户不认可         | 负样本，优化Reranker  |
| **REPORTED** | 已举报 | 内容违规           | 人工审核+敏感词库更新 |

**反馈数据闭环公式**：

```java
// 反馈驱动的Reranker优化（F001）
public void optimizeReranker(Long messageId, FeedbackType feedback) {
    // 1. 获取该消息的检索上下文
    RetrievalContext ctx = retrievalLogService.getContext(messageId);
    
    // 2. 构建训练样本
    RerankerSample sample = new RerankerSample();
    sample.setQuery(ctx.getQuery());
    sample.setChunks(ctx.getRetrievedChunks());
    sample.setRelevance(feedback == FeedbackType.LIKED ? 1.0 : 0.0);
    
    // 3. 写入反馈训练池（每日批量 fine-tune）
    feedbackPoolService.add(sample);
    
    // 4. 更新知识热度（热点问题识别）
    if (feedback == FeedbackType.LIKED) {
        hotQuestionService.increment(ctx.getQuery(), ctx.getKbId());
    }
}
```

---

## 三、关键业务公式与计算逻辑

### 3.1 RAG检索评分公式（F001-F005）

| 公式编号 | 公式名称   | 计算公式                                                     | 精度    | 示例   |
| :------- | :--------- | :----------------------------------------------------------- | :------ | :----- |
| **F001** | 向量相似度 | `cosine_similarity(query_vec, chunk_vec)`                    | 4位小数 | 0.8234 |
| **F002** | 重排分数   | `reranker_score(query, chunk)`                               | 4位小数 | 0.9123 |
| **F003** | 综合相关性 | `α*vector_sim + β*rerank_score + γ*click_rate`               | 4位小数 | 0.8567 |
| **F004** | 上下文窗口 | `min(history_tokens, max_context - prompt_tokens - reserved)` | Token数 | 3500   |
| **F005** | 回答置信度 | `avg(top3_similarity) * (1 - hallucination_score)`           | 4位小数 | 0.7234 |

### 3.2 对话上下文管理量化指标

| 控制点           | 指标定义               | 阈值  | 超限处理         |
| :--------------- | :--------------------- | :---- | :--------------- |
| **单会话轮数**   | 同一session的消息对数  | ≤50轮 | 提示新建会话     |
| **上下文Token**  | 历史对话Token总数      | ≤4000 | 滑动窗口丢弃早期 |
| **单轮响应时间** | 首字节返回时间（TTFB） | ≤2秒  | 降级为本地模型   |
| **完整生成时间** | 流式输出完成时间       | ≤15秒 | 中断后返回部分   |
| **会话空闲超时** | 最后消息到关闭时间     | 5分钟 | 自动归档会话     |

---

## 四、日终对账与一致性校验SQL

### 4.1 数据一致性校验（核心）

```sql
-- ============================================
-- 智能问答系统日终对账6项核心检查
-- 执行方式：mysql -u root -p campus_qa < check-daily.sql
-- 通过标准：6项全部返回空集
-- ============================================

-- 检查1：会话状态不一致（CLOSED但消息仍在生成）
-- 来源：防止"会话已关闭但LLM仍在输出"问题
SELECT 
    '【致命】会话状态不一致' as check_item,
    c.id as conversation_id,
    c.status as conv_status,
    m.id as message_id,
    m.status as msg_status,
    m.role,
    c.update_time
FROM t_conversation c
JOIN t_message m ON c.id = m.conversation_id
WHERE c.status = 'CLOSED'
    AND m.status IN ('GENERATING', 'PENDING', 'RETRIEVING')
    AND m.create_time > DATE_SUB(NOW(), INTERVAL 1 DAY);

-- 检查2：消息孤儿（无对应会话）
-- 来源：防止"消息未归档"导致数据丢失
SELECT 
    '【致命】消息孤儿记录' as check_item,
    m.id as message_id,
    m.conversation_id,
    m.content_preview,
    m.create_time
FROM t_message m
LEFT JOIN t_conversation c ON m.conversation_id = c.id
WHERE c.id IS NULL
    AND m.create_time > DATE_SUB(NOW(), INTERVAL 7 DAY);

-- 检查3：向量检索记录缺失（RAG链路断裂）
-- 来源：防止"直接调用LLM无检索"导致幻觉
SELECT 
    '【致命】RAG链路断裂' as check_item,
    m.id as message_id,
    m.conversation_id,
    m.content as answer,
    m.create_time
FROM t_message m
LEFT JOIN t_retrieval_record r ON m.id = r.message_id
WHERE m.role = 'ASSISTANT'
    AND m.msg_type = 'KNOWLEDGE'
    AND r.id IS NULL
    AND m.create_time > DATE_SUB(NOW(), INTERVAL 1 DAY);

-- 检查4：模型调用日志缺失（计费/审计风险）
-- 来源：防止"无调用记录但产生了回答"（安全漏洞）
SELECT 
    '【致命】模型调用日志缺失' as check_item,
    m.id as message_id,
    m.content_length,
    m.create_time
FROM t_message m
LEFT JOIN t_model_call_log l ON m.id = l.message_id
WHERE m.role = 'ASSISTANT'
    AND l.id IS NULL
    AND m.create_time > DATE_SUB(NOW(), INTERVAL 1 DAY);

-- 检查5：反馈孤儿（反馈指向不存在的消息）
-- 来源：防止"反馈数据悬空"
SELECT 
    '【警告】反馈孤儿记录' as check_item,
    f.id as feedback_id,
    f.message_id,
    f.feedback_type,
    f.create_time
FROM t_feedback f
LEFT JOIN t_message m ON f.message_id = m.id
WHERE m.id IS NULL;

-- 检查6：知识分片与向量不一致
-- 来源：防止"知识已更新但向量未重建"
SELECT 
    '【致命】知识向量不一致' as check_item,
    k.id as chunk_id,
    k.kb_id,
    k.update_time as chunk_update_time,
    v.update_time as vector_update_time,
    TIMESTAMPDIFF(MINUTE, k.update_time, v.update_time) as diff_minutes
FROM t_knowledge_chunk k
LEFT JOIN t_vector_embedding v ON k.id = v.chunk_id
WHERE v.id IS NULL 
   OR ABS(TIMESTAMPDIFF(MINUTE, k.update_time, v.update_time)) > 5;
```

### 4.2 性能与质量校验

```sql
-- 检查7：慢查询监控（检索>500ms）
SELECT 
    '【警告】慢检索查询' as check_item,
    r.message_id,
    r.retrieval_type,
    r.retrieval_time_ms,
    r.query_text_preview,
    r.create_time
FROM t_retrieval_record r
WHERE r.retrieval_time_ms > 500
    AND r.create_time > DATE_SUB(NOW(), INTERVAL 1 DAY);

-- 检查8：LLM调用超时（>10秒）
SELECT 
    '【警告】LLM调用超时' as check_item,
    l.message_id,
    l.model_name,
    l.call_duration_ms,
    l.prompt_tokens,
    l.completion_tokens,
    l.create_time
FROM t_model_call_log l
WHERE l.call_duration_ms > 10000
    AND l.create_time > DATE_SUB(NOW(), INTERVAL 1 DAY);

-- 检查9：高频敏感词触发（安全审计）
SELECT 
    word,
    COUNT(*) as trigger_count,
    GROUP_CONCAT(DISTINCT user_id) as affected_users
FROM t_sensitive_word_log
WHERE create_time > DATE_SUB(NOW(), INTERVAL 1 DAY)
GROUP BY word
HAVING trigger_count > 10;
```

---

## 五、数据库表变更DDL（必须执行）

### 5.1 核心表：对话会话表

```sql
-- 对话会话表（状态机核心载体）
CREATE TABLE `t_conversation` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
    `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
    `session_id` VARCHAR(64) NOT NULL COMMENT '微信session标识',
    `status` VARCHAR(20) NOT NULL DEFAULT 'INIT' COMMENT 'INIT/UNDERSTANDING/RETRIEVING/GENERATING/COMPLETED/CLOSED',
    `intent` VARCHAR(50) DEFAULT NULL COMMENT '主导意图',
    `confidence` DECIMAL(4,4) DEFAULT NULL COMMENT '意图置信度',
    `start_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `end_time` DATETIME DEFAULT NULL,
    `last_msg_time` DATETIME DEFAULT NULL COMMENT '最后消息时间（用于超时判断）',
    `context_snapshot` JSON DEFAULT NULL COMMENT '上下文快照（归档时）',
    `status_history` JSON DEFAULT NULL COMMENT '状态变更历史',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_session_id` (`session_id`),
    KEY `idx_user_status` (`user_id`, `status`),
    KEY `idx_status_time` (`status`, `last_msg_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='对话会话表';
```

### 5.2 核心表：消息记录表

```sql
-- 消息记录表（完整RAG链路记录）
CREATE TABLE `t_message` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
    `conversation_id` BIGINT UNSIGNED NOT NULL COMMENT '会话ID',
    `msg_seq` INT UNSIGNED NOT NULL COMMENT '消息序列号（会话内自增）',
    `role` VARCHAR(20) NOT NULL COMMENT 'USER/ASSISTANT/SYSTEM',
    `content` TEXT NOT NULL COMMENT '消息内容',
    `content_length` INT UNSIGNED NOT NULL COMMENT '内容长度（字符数）',
    `msg_type` VARCHAR(20) DEFAULT 'TEXT' COMMENT 'TEXT/KNOWLEDGE/FALLBACK/SENSITIVE',
    `intent` VARCHAR(50) DEFAULT NULL COMMENT '识别意图',
    `intent_confidence` DECIMAL(4,4) DEFAULT NULL,
    `status` VARCHAR(20) NOT NULL DEFAULT 'PENDING' COMMENT 'PENDING/FILTERING/BLOCKED/INTENT_ANALYZING/RETRIEVING/GENERATING/DELIVERED/FAILED',
    `retrieval_record_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '关联检索记录',
    `model_call_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '关联模型调用记录',
    `token_count` INT UNSIGNED DEFAULT NULL COMMENT 'Token消耗',
    `generate_time_ms` INT UNSIGNED DEFAULT NULL COMMENT '生成耗时（毫秒）',
    `feedback_status` VARCHAR(20) DEFAULT 'PENDING' COMMENT 'PENDING/LIKED/DISLIKED/REPORTED',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_conv_seq` (`conversation_id`, `msg_seq`),
    KEY `idx_conv_role` (`conversation_id`, `role`),
    KEY `idx_status_time` (`status`, `create_time`),
    KEY `idx_feedback` (`feedback_status`, `create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息记录表';
```

### 5.3 核心表：检索记录表

```sql
-- RAG检索记录表（完整链路追踪）
CREATE TABLE `t_retrieval_record` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
    `message_id` BIGINT UNSIGNED NOT NULL COMMENT '关联消息ID',
    `query_text` VARCHAR(1000) NOT NULL COMMENT '查询文本',
    `query_vector` JSON DEFAULT NULL COMMENT '查询向量（备用）',
    `retrieval_type` VARCHAR(20) NOT NULL COMMENT 'VECTOR/KEYWORD/BLEND',
    `vector_db_type` VARCHAR(20) DEFAULT 'MILVUS' COMMENT 'MILVUS/ES/FAKE',
    `top_k` INT NOT NULL DEFAULT 5 COMMENT '检索数量',
    `top_k_ids` JSON NOT NULL COMMENT '检索结果ID列表',
    `top_k_similarities` JSON NOT NULL COMMENT '相似度分数列表',
    `rerank_enabled` TINYINT DEFAULT 1 COMMENT '是否启用重排',
    `rerank_scores` JSON DEFAULT NULL COMMENT '重排后分数',
    `final_chunks` JSON NOT NULL COMMENT '最终选用的知识分片',
    `retrieval_time_ms` INT UNSIGNED NOT NULL COMMENT '检索耗时',
    `context_assembled` TEXT DEFAULT NULL COMMENT '组装后的上下文',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_message_id` (`message_id`),
    KEY `idx_type_time` (`retrieval_type`, `create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='检索记录表';
```

### 5.4 核心表：模型调用日志表

```sql
-- 模型调用日志表（计费与审计）
CREATE TABLE `t_model_call_log` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
    `message_id` BIGINT UNSIGNED NOT NULL COMMENT '关联消息ID',
    `model_name` VARCHAR(50) NOT NULL COMMENT '模型名称',
    `model_version` VARCHAR(20) DEFAULT NULL,
    `api_endpoint` VARCHAR(255) NOT NULL,
    `prompt_tokens` INT UNSIGNED NOT NULL COMMENT 'Prompt Token数',
    `completion_tokens` INT UNSIGNED NOT NULL COMMENT '生成Token数',
    `total_tokens` INT UNSIGNED NOT NULL COMMENT '总Token数',
    `call_duration_ms` INT UNSIGNED NOT NULL COMMENT '调用耗时',
    `status` VARCHAR(20) NOT NULL COMMENT 'SUCCESS/TIMEOUT/ERROR/RATE_LIMIT',
    `error_msg` VARCHAR(500) DEFAULT NULL,
    `cost_estimate` DECIMAL(10,6) DEFAULT NULL COMMENT '预估费用（元）',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_message_id` (`message_id`),
    KEY `idx_model_time` (`model_name`, `create_time`),
    KEY `idx_status_time` (`status`, `create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='模型调用日志表';
```

### 5.5 核心表：知识分片与向量表

```sql
-- 知识分片表（元数据存储）
CREATE TABLE `t_knowledge_chunk` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
    `kb_id` BIGINT UNSIGNED NOT NULL COMMENT '知识库ID',
    `doc_id` VARCHAR(64) NOT NULL COMMENT '原始文档ID',
    `chunk_seq` INT UNSIGNED NOT NULL COMMENT '分片序号',
    `chunk_content` TEXT NOT NULL COMMENT '分片内容',
    `chunk_length` INT UNSIGNED NOT NULL COMMENT '内容长度',
    `metadata` JSON DEFAULT NULL COMMENT '元数据（标题/来源/时间等）',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '1-有效 0-无效',
    `version_no` VARCHAR(32) DEFAULT 'v1.0.0' COMMENT '版本号',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_doc_seq` (`doc_id`, `chunk_seq`),
    KEY `idx_kb_status` (`kb_id`, `status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='知识分片表';

-- 向量嵌入表（与向量数据库映射）
CREATE TABLE `t_vector_embedding` (
    `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '主键',
    `chunk_id` BIGINT UNSIGNED NOT NULL COMMENT '关联分片ID',
    `vector_store_id` VARCHAR(64) NOT NULL COMMENT '向量库中的ID（如Milvus ID）',
    `dimension` INT NOT NULL DEFAULT 1536 COMMENT '向量维度',
    `model_name` VARCHAR(50) NOT NULL COMMENT 'Embedding模型',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '1-有效 0-已删除',
    `sync_time` DATETIME NOT NULL COMMENT '同步时间',
    `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_chunk_id` (`chunk_id`),
    UNIQUE KEY `uk_vector_store_id` (`vector_store_id`),
    KEY `idx_model_status` (`model_name`, `status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='向量嵌入表';
```

---

## 六、与艺术品交易系统差异对照

| 维度           | 艺术品交易系统（杨景煊）         | 校园智能问答系统（周震）         |
| :------------- | :------------------------------- | :------------------------------- |
| **核心数据**   | 订单、支付、库存、资金流水       | 对话、消息、知识分片、向量嵌入   |
| **状态机重点** | 交易状态（待付款→已发货→已完成） | 对话状态（理解→检索→生成→完成）  |
| **一致性核心** | 资金守恒（钱包+流水=0）          | RAG链路完整（检索→生成可追溯）   |
| **并发控制**   | 分布式锁防超卖                   | 滑动窗口防Token超限              |
| **存储特性**   | 强事务（MySQL ACID）             | 混合存储（MySQL+向量库+Redis）   |
| **对账重点**   | 日终资金对账（5项SQL）           | RAG链路审计（6项SQL）            |
| **降级策略**   | 库存降级为MySQL锁                | LLM降级为本地模型→兜底话术       |
| **核心公式**   | 价格计算（保证金、违约金）       | 相似度计算（向量余弦、重排分数） |

---

## 七、执行检查清单

开发每个功能时，必须确认：

- [ ] **ER图检查**：此操作涉及哪些表？关系是否正确？
- [ ] **状态机检查**：前置状态是什么？目标状态是否允许？（查第2章状态流转图）
- [ ] **RAG链路检查**：是否经过完整的检索→重排→生成链路？（查2.3检索状态机）
- [ ] **向量一致性检查**：知识更新后向量是否同步重建？（查5.5向量表）
- [ ] **对账检查**：如何通过SQL验证此操作的数据正确性？（查第4章校验SQL）
- [ ] **降级检查**：模型失败时是否有L1-L4降级策略？（查2.4降级策略表）
- [ ] **反馈闭环检查**：用户反馈是否进入训练池？（查2.6反馈状态机）

---

**文档结束**

> 本文档与《系统架构与核心决策》《API与接口契约》《编码规范与实现模板》《验收红线与自动化》配套使用，构成校园智能问答系统的完整技术规范。
>
> **关键原则**：所有对话状态变更必须通过ConversationStatusService.transition方法，禁止直接UPDATE；所有LLM生成必须有对应的retrieval_record和model_call_log；每日必须执行第4章对账SQL。